#!/usr/bin/env bash
#
# bar

main() {
	name=bar

	if xdo id -a "$name" > /dev/null; then
		echo 'error: bar is already running' >&2
		exit 1
	fi

	# proper cleanup
	trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

	# source configs
	source ~/.config/bar/config
	source ~/.config/bar/icons

	# source lemons
	for file in ~/bin/lemons/*; do
			source "$file"
	done
	
	# awwwyea
	start_lemons | format_bar | draw_bar | bash &

	# set top padding for laptop display only
	disp=$(bspc query -M | head -n 1)
	bspc config -m $disp top_padding $wmtoppad

	# ensure proper fullscreen behavior
	until bar_id="$(xdo id -a $name)"; do
		sleep 0.001
	done
	xdo above -t "$(xdo id -N Bspwm -n root | sort | head -n 1)" "$bar_id"

	# don't end the process
	wait
}

start_lemons() {
	for func in wks ttl ntw vol bri bat clk; do
		eval show=\$show_$func
		((show)) && $func &
	done
}

format_bar() {
	while read -r event; do
		case $event in
			W*) wks="${event#?} " ;;
			T*) ttl=" ${event#?} " ;;
			N*) ntw=" ${event#?} " ;;
			V*) vol=" ${event#?} " ;;
			L*) bri=" ${event#?} " ;;
			B*) bat=" ${event#?} " ;;
			C*) clk=" ${event#?} " ;;
		esac

		printf "%b\n" "%{l}$wks%{c}$ttl%{r}$ntw$vol$bri$bat$clk"
	done
}

draw_bar() {
	lemonbar -n "$name" \
		-g "${width}x$height+$offset_x+$offset_y" \
		-u "$ul_height" \
		-o "$font_offset" \
		-f "$font" \
		-o "$icon_offset" \
		-f "$icon_font" \
		-B "$c_bg" \
		-F "$c_fg"
}

sleep 0.25
main
