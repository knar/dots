#!/usr/bin/env bash
#
# bar

main() {
	name=bar

	if xdo id -a "$name" > /dev/null; then
		echo 'error: bar is already running' >&2
		exit 1
	fi

	# proper cleanup  
	trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

	# source configs
	source ~/.config/bar/config
	source ~/.config/bar/icons

	# set top padding for bar
	bspc config top_padding "$wmtoppad"

	# source lemons
	for file in ~/bin/lemons/*; do
		source "$file"
	done

	# awwwyea
	start_lemons | format_bar | draw_bar | bash &

	# ensure proper fullscreen behavior
	until bar_id="$(xdo id -a $name)"; do
		sleep 0.001
	done
	xdo above -t "$(xdo id -N Bspwm -n root | sort | head -n 1)" "$bar_id"

	# don't end the process
	wait
}

start_lemons() {
	for func in wks ttl ntw vol bri bat clk; do
		eval show=\$show_$func
		((show)) && $func &
	done
}

format_bar() {
	while read -r event; do
		var="${event:1}"
		case $event in
			W*) wks=$var ;;
			T*) ttl=$var ;;
			N*) ntw=$var ;;
			V*) vol=$var ;;
			L*) bri=$var ;;
			B*) bat=$var ;;
			C*) clk=$var ;;
		esac

		left="$wks"

		center="$ttl"

		right=""
		((show_ntw)) && right="$right $ntw "
		((show_vol)) && right="$right $vol "
		((show_bri)) && right="$right $bri "
		((show_bat)) && right="$right $bat "
		((show_clk)) && right="$right $clk "

		printf "%b\n" "%{l}$left%{c}$center%{r}$right"
	done
}

draw_bar() {
	lemonbar -n "$name" \
		-g "${width}x$height+$offset_x+$offset_y" \
		-u "$ul_height" \
		-o "$font_offset" \
		-f "$font" \
		-o "$icon_offset" \
		-f "$icon_font" \
		-B "$c_bg" \
		-F "$c_fg"
}

main
