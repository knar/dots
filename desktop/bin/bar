#!/usr/bin/env bash
#
# bar

main() {
	name=bar
	
	if xdo id -a "$name" > /dev/null; then
		echo 'error: bar is already running' >&2
		exit 1
	fi

	# proper cleanup  
	trap 'trap - TERM; kill 0' INT TERM QUIT EXIT
	
	# source configs
	source ~/.config/bar/config
	source ~/.config/bar/icons

	# set top padding for bar
	bspc config top_padding "$wmtoppad"
	
	# bar pipe
	start_lemons | format_bar | draw_bar

	# ensure proper fullscreen behavior
	until bar_id=$(xdo id -a "$name"); do
		sleep 0.001
	done
	xdo below -t $(xdo id -n root) $bar_id

	# don't end the proceess 
	wait
}

# source and invoke lemons
start_lemons() {
	for file in ~/bin/lemons/*; do
		source "$file"
	done

	for func in wks ttl ntw vol clk; do
		$func &
	done
}

# format for bar from piped fifo
format_bar() {
	num_disp=$(xrandr -q | grep " connected" | wc -l)

	while read -r event; do
		case $event in
			W*) wks=${event:1} ;;
			T*) ttl=${event:1} ;;
			N*) ntw=${event:1} ;;
			V*) vol=${event:1} ;;
			C*) clk=${event:1} ;;
		esac

		bar=""
		for ((i=0;i<$num_disp;i++)); do
			bar="$bar%{S$i}%{l}$wks  $ttl%{r}$ntw  $vol  $clk "
		done

		printf '%b\n' "$bar"
	done
}

# draw bar from piped formatted string
draw_bar() {
	lemonbar -n "$name" \
		-g "x$height" \
		-u "$underlineheight" \
		-o "$textoffset" \
		-f "$font" \
		-f "$iconfont" \
		-F "$foreground" \
		-B "$background" &
}

main
