#!/usr/bin/env bash
#
# clean bar, brutha

name=bar

if xdo id -a "$name" > /dev/null; then
	echo 'error: bar is already running' >&2
	exit 1
fi

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

source ~/.config/bar/config
source ~/.config/bar/icons

[ -e "$fifo" ] && rm "$fifo"
mkfifo "$fifo"

bspc config top_padding "$wmtoppad"

for file in ~/bin/lemons/*; do
	source "$file"
done

for func in wks ttl ntw vol clk; do
	"$func" > "$fifo" &
done

num_disp=$(xrandr -q | grep " connected" | wc -l)

cat "$fifo" | \
	while read -r event; do
		case $event in
			WORKSPACES*) wks=${event:10} ;;
			TITLE*)      ttl=${event:5} ;;
			NETWORK*)    ntw=${event:7} ;;
			VOLUME*)     vol=${event:6} ;;
			BRIGHTNESS*) bri=${event:10} ;;
			BATTERY*)    bat=${event:7} ;;
			CLOCK*)      clk=${event:5} ;;
		esac
	
		bar=""
		for ((i=0;i<$num_disp;i++)); do
			bar="$bar%{S$i}%{l}$wks  $ttl%{r}$ntw  $vol  $clk "
		done

		printf '%b\n' "$bar"
	done | \
		lemonbar -n "$name" \
			-g "x$height" \
			-u "$underlineheight" \
			-o "$textoffset" \
			-f "$font" \
			-f "$iconfont" \
			-F "$foreground" \
			-B "$background" &

# proper fullscreen behavior
until bar_id=$(xdo id -a "$name"); do
	sleep 0.001
done

xdo below -t $(xdo id -n root) $bar_id

# don't end the proceess 
wait
