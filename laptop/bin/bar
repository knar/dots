#!/usr/bin/env bash
#
# bar

main() {
	name=bar

	if xdo id -a "$name" > /dev/null; then
		echo 'error: bar is already running' >&2
		exit 1
	fi

	# proper cleanup  
	trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

	# source configs
	source ~/.config/bar/config
	source ~/.config/bar/icons

	# set top padding for bar
	bspc config top_padding "$wmtoppad"

	# source lemons
	for file in ~/bin/lemons/*; do
		source "$file"
	done

	# awwwyea
	start_lemons | format_bar | draw_bar | bash &

	# ensure proper fullscreen behavior
	until bar_id="$(xdo id -a $name)"; do
		sleep 0.001
	done
	xdo above -t "$(xdo id -N Bspwm -n root | sort | head -n 1)" "$bar_id"

	# don't end the process
	wait
}

start_lemons() {
	((show_wks)) && wks &
	((show_ttl)) && ttl &
	((show_ntw)) && ntw &
	((show_vol)) && vol &
	((show_bri)) && bri &
	((show_bat)) && bat &
	((show_clk)) && clk &
}

format_bar() {
	while read -r event; do
		case $event in
			W*) wks="${event:1}" ;;
			T*) ttl="${event:1}" ;;
			N*) ntw=" ${event:1} " ;;
			V*) vol=" ${event:1} " ;;
			L*) bri=" ${event:1} " ;;
			B*) bat=" ${event:1} " ;;
			C*) clk=" ${event:1} " ;;
		esac
			
		printf "%b\n" "%{l}$wks $ttl%{r}$ntw$vol$bat$clk"
	done
}

draw_bar() {
	lemonbar -n "$name" \
		-g "${width}x$height+$offset_x+$offset_y" \
		-u "$ul_height" \
		-o "$font_offset" \
		-f "$font" \
		-o "$icon_offset" \
		-f "$icon_font" \
		-B "$df_bg" \
		-F "$df_fg"
}

main
